<script>
/* ═══════════════════════════════════════
   SPACE + PLANETS + COUNTER + CITATIONS
═══════════════════════════════════════ */

(function () {

  /* ─────────────────────────
     CANVAS SETUP
  ───────────────────────── */
  const canvas = document.getElementById("space-canvas");
  if (!canvas) return;

  const ctx = canvas.getContext("2d");
  let W, H;
  let stars = [];
  let t = 0;

  function resize() {
    const section = document.getElementById("home");
    W = canvas.width = section.offsetWidth;
    H = canvas.height = section.offsetHeight;
    buildStars();
  }

  function buildStars() {
    stars = Array.from({ length: 300 }, () => ({
      x: Math.random() * W,
      y: Math.random() * H,
      r: Math.random() * 1.4 + 0.2,
      speed: Math.random() * 0.15 + 0.05,
      tw: Math.random() * Math.PI * 2
    }));
  }

  function drawStars() {
    stars.forEach(s => {
      const alpha = 0.4 + Math.sin(t * 0.02 + s.tw) * 0.3;
      ctx.fillStyle = `rgba(255,255,255,${alpha})`;
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
      ctx.fill();

      s.y += s.speed;
      if (s.y > H) s.y = 0;
    });
  }

  /* ─────────────────────────
     MARS (PRIMARY — LARGER)
  ───────────────────────── */
  function drawMars() {
    const cx = W * 0.35;
    const cy = H * 0.6;
    const r = Math.min(W, H) * 0.15;

    // glow
    const glow = ctx.createRadialGradient(cx, cy, 0, cx, cy, r * 2);
    glow.addColorStop(0, "rgba(255,120,80,0.4)");
    glow.addColorStop(1, "rgba(255,120,80,0)");
    ctx.fillStyle = glow;
    ctx.beginPath();
    ctx.arc(cx, cy, r * 2, 0, Math.PI * 2);
    ctx.fill();

    // base sphere
    const grad = ctx.createRadialGradient(
      cx - r * 0.4,
      cy - r * 0.4,
      r * 0.2,
      cx,
      cy,
      r
    );
    grad.addColorStop(0, "#ffb199");
    grad.addColorStop(0.5, "#c1442e");
    grad.addColorStop(1, "#4a140c");

    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI * 2);
    ctx.fill();

    // subtle rotation effect
    ctx.save();
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI * 2);
    ctx.clip();

    ctx.globalAlpha = 0.2;
    ctx.fillStyle = "#7a2b1a";
    ctx.beginPath();
    ctx.ellipse(
      cx + Math.sin(t * 0.01) * r * 0.3,
      cy,
      r * 0.8,
      r * 0.2,
      0,
      0,
      Math.PI * 2
    );
    ctx.fill();
    ctx.restore();
  }

  /* ─────────────────────────
     JUPITER (SECONDARY)
  ───────────────────────── */
  function drawJupiter() {
    const cx = W * 0.8;
    const cy = H * 0.3;
    const r = Math.min(W, H) * 0.09;

    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI * 2);
    ctx.fillStyle = "#d9b38c";
    ctx.fill();

    ctx.save();
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI * 2);
    ctx.clip();

    for (let i = -4; i <= 4; i++) {
      ctx.fillStyle = `rgba(150,100,60,${0.2 + Math.abs(i) * 0.05})`;
      ctx.fillRect(
        cx - r,
        cy + i * 6 + Math.sin(t * 0.02) * 3,
        r * 2,
        4
      );
    }

    ctx.restore();
  }

  function animate() {
    ctx.clearRect(0, 0, W, H);
    t++;
    drawStars();
    drawMars();
    drawJupiter();
    requestAnimationFrame(animate);
  }

  resize();
  window.addEventListener("resize", resize);
  animate();

})();

/* ─────────────────────────
   GOATCOUNTER FIX
───────────────────────── */
fetch("https://YOUR_GOATCOUNTER_CODE.goatcounter.com/counter/TOTAL.json")
  .then(res => res.json())
  .then(data => {
    document.getElementById("visitCount").textContent = data.count;
  })
  .catch(() => {
    document.getElementById("visitCount").textContent = "—";
  });

/* ─────────────────────────
   CROSSREF CITATION COUNTS
───────────────────────── */
const dois = {
  1: "10.1029/2025JE008934",
  2: "10.1029/2023JE008227",
  3: "10.1029/2022JE007302",
  4: "10.1016/j.newast.2019.101349",
  5: "10.1016/j.heliyon.2019.e02972",
  6: "10.XXXX/XXXX" // replace if needed
};

Object.entries(dois).forEach(([id, doi]) => {
  fetch(`https://api.crossref.org/works/${doi}`)
    .then(res => res.json())
    .then(data => {
      const count = data.message["is-referenced-by-count"];
      const el = document.querySelector(`#cite-${id} .cite-num`);
      if (el) {
        el.textContent = count;
        el.classList.remove("cite-loading");
      }
    })
    .catch(() => {
      const el = document.querySelector(`#cite-${id} .cite-num`);
      if (el) el.textContent = "—";
    });
});
</script>
